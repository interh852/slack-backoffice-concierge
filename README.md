# Backoffice Concierge 🤖✨

Google Apps Script (GAS) と Gemini API を活用した、バックオフィス業務を自動化する高度な Google Chat ボットです。
AI 技術を搭載し、自然言語での対話を通じて複雑な事務作業をスマートに処理します。

## 🌟 主な機能

### 1. AI による自然言語解析
Gemini API を統合しており、ユーザーの曖昧な入力から意図を抽出します。
- **自由な入力**: 「交通費精算して」「片道450円で申請」「昨日の分忘れてた」など、自然な会話で操作が可能。
- **意図の自動判別**: 入力内容から「精算の開始」や「金額の設定」を賢く判断します。

### 2. 通勤費精算の自動化
Google カレンダーの「出社」イベントを自動集計し、専用のスプレッドシートに出力します。
- **集計期間**: 常に「依頼日の前月16日〜当月15日」を対象として集計します。
- **出社日の抽出**: カレンダーから抽出された出社日は、年を除いた `M/D` 形式（例: 1/1）でリスト化され、精算書に記録されます。
- **運賃の自動再利用**: 先月の精算実績がある場合、ボットが自動的に過去の片道運賃を取得し、再利用するかを確認します。
- **自動計算**: 片道の金額を決定するだけで、往復分を自動計算して申請。
- **個別ファイル出力**: 指定のテンプレートをコピーして、Google Drive 上に個人別の精算書（スプレッドシート）を自動作成します。
- **自動フォルダ整理**: 保存先フォルダ（デフォルト：`backoffice-concierge/通勤費`）が自動的に作成され、整理されます。

## 🚀 セットアップ

### 1. 依存関係のインストール
```bash
npm install
```

### 2. GAS プロジェクトへのデプロイ
`clasp` を使用してデプロイします。
```bash
clasp login
clasp push
```

### 3. スクリプトプロパティの設定
GAS の「プロジェクトの設定」にて、以下のスクリプトプロパティを設定してください。

| プロパティ名 | 説明 |
| :--- | :--- |
| `COMMUTE_EXPENSE_SPREDSHEET` | 設定管理用（モデル・プロンプト）の Google スプレッドシート ID |
| `COMMUTE_TEMPLATE_SPREADSHEET` | 精算書の雛形となるテンプレートスプレッドシートの ID |
| `GEMINI_API_KEY` | Google AI Studio で発行した Gemini API キー |

### 4. 設定用スプレッドシートの準備
`COMMUTE_EXPENSE_SPREDSHEET` で指定したスプレッドシートに以下のシートを作成してください。

#### 「情報」シート
ボットの動作モデルを指定します。
- **B1 セル**: 使用するモデル名（例: `gemini-2.5-flash-lite`）

#### 「通勤費」シート
AI の振る舞いを定義するシステムプロンプトを設定します。
- **B1 セル**: システムプロンプト（AI への指示文）

## 📖 使い方

1. Google Chat で 「Backoffice Concierge」を開始。
2. **「通勤費の精算をお願い」** のように話しかけます。
3. ボットとの対話（すべて**テキストチャット**で行います）:
    - **先月の運賃がある場合**: ボットが「先月の運賃 **〇〇円** を再利用しますか？」と尋ねます。**「はい」** または **「いいえ」** と返信してください。
    - **運賃を新しく指定する場合**: 「片道運賃を教えてください」と促されたら、**「500」** のように数字を入力するか、**「片道500円」** のように答えてください。
    - **中断したい場合**: **「キャンセル」** と入力すると、現在の処理を中断します。
4. カレンダーから出社日が抽出され、Google Drive の指定フォルダに精算書が作成されます。作成されたファイルの URL がチャットに返信されます。

## 🛠 テクニカルスタック

- **Engine**: Google Apps Script (GAS)
- **AI**: Gemini 2.5 Flash Lite (Google AI Studio)
- **Services**: Google Calendar API, Google Drive API, Google Sheets API, Google Chat API
- **Tooling**: Clasp, Jest (Testing), Prettier

## 🏗 ディレクトリ構成
```
src/
├── ChatHandler.js           # チャットイベントのハンドリング & 意図解析
├── GeminiService.js         # Gemini API との通信
├── CommuteExpenseUseCase.js # 通勤費精算のビジネスロジック
├── CalendarService.js       # Googleカレンダー連携
├── SpreadsheetService.js    # スプレッドシート連携
├── PeriodCalculator.js      # 精算期間の計算ロジック
├── Constants.js             # 定数・設定管理
└── main.js                  # エントリーポイント
```

## ✅ 開発者向け
### テストの実行
```bash
npm test
```
### コードフォーマット
```bash
npm run format
```
